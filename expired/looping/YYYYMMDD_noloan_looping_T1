/* Data/customers 	 $A$ 
 Data/leads 	 $B$ 
 Data/credit_decisions 	 $C$ 
 Data/loans 	 $D$ */

SELECT DISTINCT c.email_address_, 
                c.riid_ 
FROM   $b$ le 
       INNER JOIN $a$ c 
               ON c.ac_id = le.customer_id 
       LEFT JOIN (SELECT $c$.customer_id, 
                         $c$.created_at, 
                         $c$.approved, 
                         Row_number() 
                           OVER ( 
                             partition BY $c$.customer_id 
                             ORDER BY $c$.created_at DESC) row_num 
                  FROM   $c$) cd 
              ON cd.customer_id = le.customer_id 
                 AND cd.row_num = 1 
WHERE  0 = 0 
       AND le.ac_source = 'lending_tree' 
       AND le.decision = 'import' 
       AND NOT EXISTS (SELECT $d$.ac_id 
                       FROM   $d$ 
                       WHERE  $d$.customer_id = le.customer_id) 
       AND ( cd.approved = 'true' 
              OR cd.approved IS NULL ) 
       AND To_char(Cast(( From_tz(Cast(le.created_at AS TIMESTAMP), '+00:00') at time zone 'US/Central' ) AS DATE), 'yyyy-mm-dd') = To_char(( sysdate - 2 ), 'yyyy-mm-dd') 
       AND c.riid_ IS NOT NULL 
